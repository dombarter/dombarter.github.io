<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs | Dom Barter</title>
<meta name="keywords" content="">
<meta name="description" content="Test the full lifecycle of your API controllers using integration tests. Combined with in-memory databases you can fully mock your system and reproducible results. This approach even deals with cookies, so you can authenticate using a JWT in a cookie.">
<meta name="author" content="Dom Barter">
<link rel="canonical" href="https://dombarter.co.uk/posts/add-integration-tests-for-dotnet-web-api/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://dombarter.co.uk/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dombarter.co.uk/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dombarter.co.uk/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dombarter.co.uk/apple-touch-icon.png">
<link rel="mask-icon" href="https://dombarter.co.uk/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs" />
<meta property="og:description" content="Test the full lifecycle of your API controllers using integration tests. Combined with in-memory databases you can fully mock your system and reproducible results. This approach even deals with cookies, so you can authenticate using a JWT in a cookie." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dombarter.co.uk/posts/add-integration-tests-for-dotnet-web-api/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-25T15:08:39&#43;01:00" />
<meta property="article:modified_time" content="2022-08-25T15:08:39&#43;01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs"/>
<meta name="twitter:description" content="Test the full lifecycle of your API controllers using integration tests. Combined with in-memory databases you can fully mock your system and reproducible results. This approach even deals with cookies, so you can authenticate using a JWT in a cookie."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://dombarter.co.uk/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs",
      "item": "https://dombarter.co.uk/posts/add-integration-tests-for-dotnet-web-api/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs",
  "name": "Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs",
  "description": "Test the full lifecycle of your API controllers using integration tests. Combined with in-memory databases you can fully mock your system and reproducible results. This approach even deals with cookies, so you can authenticate using a JWT in a cookie.",
  "keywords": [
    
  ],
  "articleBody": "GitHub Repository A full example of this code can be found at https://github.com/dombarter/Solar.API\nMotivation As you may have seen from my previous posts, I’ve been experimenting with creating a .NET 6 Web API that uses Entity Framework, Identity and JWTs as cookies that can be consumed by a Vue.js SPA. I’ve not delved into the world of integration tests too much but thought it would be a really interesting concept to create an entire test database and test our full controller lifecycle, as this will catch errors at any level.\nCreate Your Test Project The first step is to make a xUnit test project to complement your API project.\nOur API project is called Solar.API and we created a new xUnit project called Solar.API.Test.\nNuGet Packages You need to install the following NuGet packages:\n Microsoft.AspNetCore.Mvc.Testing - for mocking the controllers Microsoft.EntityFrameworkCore.InMemory - for creating an empty test database  API Startup Class Our integration tests need to access our startup class, Program.cs so they can create a mock of the controllers. We need to make some slight adjustments to the access levels because by default it is only internally accessible.\nGo to Program.cs and add this line at the bottom of the file:\napp.Run(); public partial class Program {} // Integration Tests Base Class Now we need to make a base class that all our integration tests will inherit. In this class we will provide a few important things:\n GenerateClient - for creating a mock of the controllers, and swapping out our SQL Server for an empty in-memory equivalent Authentication helper methods  GenerateClient The GenerateClient performs the following:\n Creates a new WebApplicationFactory based on our API startup class It then amends the startup class, by changing some of the services It firstly removes the existing DbContext service It then replaces it with a new DbContext class that uses an in-memory database with a unique name (this ensures each integration test has an empty database to work with) It finally defines a custom https endpoint for the mocked controller, meaning our Secure JWT cookies can be transmitted  public class IntegrationTestsBase { protected HttpClient GenerateClient() { // Build up the API, using an in memory database  var application = new WebApplicationFactory() .WithWebHostBuilder(builder = { builder.ConfigureServices(services = { // Remove the db context  services.RemoveAll(typeof(DbContextOptions)); // Replace the connection with an in memory equivalent  var dbName = Guid.NewGuid().ToString(); services.AddDbContext(options = { options.UseInMemoryDatabase(dbName); }); }); }); // Generate the client  var client = application.CreateClient(new WebApplicationFactoryClientOptions { BaseAddress = new Uri(\"https://localhost\") }); return client; } } Write Some Tests! You can now write some tests. Here are some examples of what you can do:\nMaking Sure Endpoints Are Protected in this example we make GET requests to multiple endpoints we know should be protected under normal circumstances. We make sure that a 401 code is returned.\npublic class MoonControllerTests : IntegrationTestsBase { [Theory] [InlineData(\"/moons/one\")] [InlineData(\"/moons/two\")] public async Task Get_WhenUnauthenticated_ReturnsUnauthorized(string url) { // Arrange  var client = GenerateClient(); // Act  var response = await client.GetAsync(url); // Assert  Assert.Equal(HttpStatusCode.Unauthorized, response.StatusCode); } } Registering \u0026 Logging In In this example we register a new user, then login as them and make sure that both requests return an OK response indicating the request was a success.\npublic class AccountControllerTests : IntegrationTestsBase { [Fact] public async Task Post_Login_ReturnsOK() { // Arrange  var client = GenerateClient(); // Act  var register = await Register(client, new RegisterDto { Email = \"dom@email.com\", Password = \"password\" }); var login = await Login(client, new LoginDto { Email = \"dom@email.com\", Password = \"password\" }); // Assert  Assert.Equal(HttpStatusCode.OK, register.StatusCode); Assert.Equal(HttpStatusCode.OK, login.StatusCode); } } Where Login and Register are some helper methods I was talking about earlier:\nprotected async Task Register(HttpClient client, RegisterDto registerDto) { // Act  var response = await client.PostAsJsonAsync(\"/user/register\", registerDto); return response; } protected async Task Login(HttpClient client, LoginDto loginDto) { // Act  var response = await client.PostAsJsonAsync(\"/user/login\", loginDto); return response; } Requesting An Endpoint When Authenticated In this example, we authenticate the request by registering and logging in using a helper method. This stores a JWT cookie. We then make a request to an endpoint that would usually be protected and make sure that the response is OK.\npublic class MoonControllerTests : IntegrationTestsBase { [Fact] public async Task Get_OneMoon_AsUser() { // Arrange  var client = GenerateClient(); await AuthenticateAsUser(client); // Act  var response = await client.GetAsync(\"/moons/one\"); // Assert  Assert.Equal(HttpStatusCode.OK, response.StatusCode); } } References Based on the following websites:\n https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-6.0 https://stackoverflow.com/questions/70900451/c-sharp-netcore-webapi-integration-testing-httpclient-uses-https-for-get-reques  ",
  "wordCount" : "736",
  "inLanguage": "en",
  "datePublished": "2022-08-25T15:08:39+01:00",
  "dateModified": "2022-08-25T15:08:39+01:00",
  "author":{
    "@type": "Person",
    "name": "Dom Barter"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dombarter.co.uk/posts/add-integration-tests-for-dotnet-web-api/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dom Barter",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dombarter.co.uk/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dombarter.co.uk/" accesskey="h" title="Dom Barter (Alt + H)">Dom Barter</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://dombarter.co.uk/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://dombarter.co.uk/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://dombarter.co.uk/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://dombarter.co.uk/">Home</a>&nbsp;»&nbsp;<a href="https://dombarter.co.uk/posts/">Posts</a></div>
    <h1 class="post-title">
      Add integration tests to an existing .NET 6 Web API using Entity Framework, Identity and JWTs
    </h1>
    <div class="post-meta"><span title='2022-08-25 15:08:39 +0100 +0100'>August 25, 2022</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Dom Barter

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul><ul><ul>
                <li>
                    <a href="#github-repository" aria-label="GitHub Repository">GitHub Repository</a></li></ul>
                    </ul>
                    
                <li>
                    <a href="#motivation" aria-label="Motivation">Motivation</a></li>
                <li>
                    <a href="#create-your-test-project" aria-label="Create Your Test Project">Create Your Test Project</a></li>
                <li>
                    <a href="#nuget-packages" aria-label="NuGet Packages">NuGet Packages</a></li>
                <li>
                    <a href="#api-startup-class" aria-label="API Startup Class">API Startup Class</a></li>
                <li>
                    <a href="#integration-tests-base-class" aria-label="Integration Tests Base Class">Integration Tests Base Class</a><ul>
                        
                <li>
                    <a href="#generateclient" aria-label="GenerateClient">GenerateClient</a></li></ul>
                </li>
                <li>
                    <a href="#write-some-tests" aria-label="Write Some Tests!">Write Some Tests!</a><ul>
                        
                <li>
                    <a href="#making-sure-endpoints-are-protected" aria-label="Making Sure Endpoints Are Protected">Making Sure Endpoints Are Protected</a></li>
                <li>
                    <a href="#registering--logging-in" aria-label="Registering &amp;amp; Logging In">Registering &amp; Logging In</a></li>
                <li>
                    <a href="#requesting-an-endpoint-when-authenticated" aria-label="Requesting An Endpoint When Authenticated">Requesting An Endpoint When Authenticated</a></li></ul>
                </li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="github-repository">GitHub Repository<a hidden class="anchor" aria-hidden="true" href="#github-repository">#</a></h3>
<p>A full example of this code can be found at <a href="https://github.com/dombarter/Solar.API">https://github.com/dombarter/Solar.API</a></p>
<h1 id="motivation">Motivation<a hidden class="anchor" aria-hidden="true" href="#motivation">#</a></h1>
<p>As you may have seen from my previous posts, I&rsquo;ve been experimenting with creating a .NET 6 Web API that uses Entity Framework, Identity and JWTs as cookies that can be consumed by a Vue.js SPA. I&rsquo;ve not delved into the world of integration tests too much but thought it would be a really interesting concept to create an entire test database and test our full controller lifecycle, as this will catch errors at any level.</p>
<h1 id="create-your-test-project">Create Your Test Project<a hidden class="anchor" aria-hidden="true" href="#create-your-test-project">#</a></h1>
<p>The first step is to make a <code>xUnit</code> test project to complement your <code>API</code> project.</p>
<p>Our <code>API</code> project is called <code>Solar.API</code> and we created a new <code>xUnit</code> project called <code>Solar.API.Test</code>.</p>
<h1 id="nuget-packages">NuGet Packages<a hidden class="anchor" aria-hidden="true" href="#nuget-packages">#</a></h1>
<p>You need to install the following NuGet packages:</p>
<ul>
<li><code>Microsoft.AspNetCore.Mvc.Testing</code> - for mocking the controllers</li>
<li><code>Microsoft.EntityFrameworkCore.InMemory</code> - for creating an empty test database</li>
</ul>
<h1 id="api-startup-class">API Startup Class<a hidden class="anchor" aria-hidden="true" href="#api-startup-class">#</a></h1>
<p>Our integration tests need to access our startup class, <code>Program.cs</code> so they can create a mock of the controllers. We need to make some slight adjustments to the access levels because by default it is only internally accessible.</p>
<p>Go to <code>Program.cs</code> and add this line at the bottom of the file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">app.Run();

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">partial</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span> {} <span style="color:#75715e">// &lt;-- add this line!
</span></code></pre></div><h1 id="integration-tests-base-class">Integration Tests Base Class<a hidden class="anchor" aria-hidden="true" href="#integration-tests-base-class">#</a></h1>
<p>Now we need to make a base class that all our integration tests will inherit. In this class we will provide a few important things:</p>
<ul>
<li><code>GenerateClient</code> - for creating a mock of the controllers, and swapping out our SQL Server for an empty in-memory equivalent</li>
<li>Authentication helper methods</li>
</ul>
<h2 id="generateclient">GenerateClient<a hidden class="anchor" aria-hidden="true" href="#generateclient">#</a></h2>
<p>The <code>GenerateClient</code> performs the following:</p>
<ul>
<li>Creates a new <code>WebApplicationFactory</code> based on our <code>API</code> startup class</li>
<li>It then amends the startup class, by changing some of the services</li>
<li>It firstly removes the existing <code>DbContext</code> service</li>
<li>It then replaces it with a new <code>DbContext</code> class that uses an in-memory database with a unique name (this ensures each integration test has an empty database to work with)</li>
<li>It finally defines a custom <code>https</code> endpoint for the mocked controller, meaning our <code>Secure</code> JWT cookies can be transmitted</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IntegrationTestsBase</span>
{
    <span style="color:#66d9ef">protected</span> HttpClient GenerateClient()
    {
        <span style="color:#75715e">// Build up the API, using an in memory database
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> application = <span style="color:#66d9ef">new</span> WebApplicationFactory&lt;Program&gt;()
            .WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureServices(services =&gt;
                {
                    <span style="color:#75715e">// Remove the db context
</span><span style="color:#75715e"></span>                    services.RemoveAll(<span style="color:#66d9ef">typeof</span>(DbContextOptions&lt;SolarDbContext&gt;));

                    <span style="color:#75715e">// Replace the connection with an in memory equivalent
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">var</span> dbName = Guid.NewGuid().ToString();
                    services.AddDbContext&lt;SolarDbContext&gt;(options =&gt;
                    {
                        options.UseInMemoryDatabase(dbName);
                    });
                });
            });

        <span style="color:#75715e">// Generate the client
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> client = application.CreateClient(<span style="color:#66d9ef">new</span> WebApplicationFactoryClientOptions { BaseAddress = <span style="color:#66d9ef">new</span> Uri(<span style="color:#e6db74">&#34;https://localhost&#34;</span>) });
        <span style="color:#66d9ef">return</span> client;
    }
}
</code></pre></div><h1 id="write-some-tests">Write Some Tests!<a hidden class="anchor" aria-hidden="true" href="#write-some-tests">#</a></h1>
<p>You can now write some tests. Here are some examples of what you can do:</p>
<h2 id="making-sure-endpoints-are-protected">Making Sure Endpoints Are Protected<a hidden class="anchor" aria-hidden="true" href="#making-sure-endpoints-are-protected">#</a></h2>
<p>in this example we make <code>GET</code> requests to multiple endpoints we know should be protected under normal circumstances. We make sure that a 401 code is returned.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MoonControllerTests</span> : IntegrationTestsBase
{
<span style="color:#a6e22e">    [Theory]</span>
<span style="color:#a6e22e">    [InlineData(&#34;/moons/one&#34;)]</span>
<span style="color:#a6e22e">    [InlineData(&#34;/moons/two&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task Get_WhenUnauthenticated_ReturnsUnauthorized(<span style="color:#66d9ef">string</span> url)
    {
        <span style="color:#75715e">// Arrange
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> client = GenerateClient();

        <span style="color:#75715e">// Act
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> response = <span style="color:#66d9ef">await</span> client.GetAsync(url);

        <span style="color:#75715e">// Assert
</span><span style="color:#75715e"></span>        Assert.Equal(HttpStatusCode.Unauthorized, response.StatusCode);
    }
}
</code></pre></div><h2 id="registering--logging-in">Registering &amp; Logging In<a hidden class="anchor" aria-hidden="true" href="#registering--logging-in">#</a></h2>
<p>In this example we register a new user, then login as them and make sure that both requests return an <code>OK</code> response indicating the request was a success.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AccountControllerTests</span> : IntegrationTestsBase
{
<span style="color:#a6e22e">    [Fact]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task Post_Login_ReturnsOK()
    {
        <span style="color:#75715e">// Arrange
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> client = GenerateClient();

        <span style="color:#75715e">// Act
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> register = <span style="color:#66d9ef">await</span> Register(client, <span style="color:#66d9ef">new</span> RegisterDto
        {
            Email = <span style="color:#e6db74">&#34;dom@email.com&#34;</span>,
            Password = <span style="color:#e6db74">&#34;password&#34;</span>
        });

        <span style="color:#66d9ef">var</span> login = <span style="color:#66d9ef">await</span> Login(client, <span style="color:#66d9ef">new</span> LoginDto
        {
            Email = <span style="color:#e6db74">&#34;dom@email.com&#34;</span>,
            Password = <span style="color:#e6db74">&#34;password&#34;</span>
        });

        <span style="color:#75715e">// Assert
</span><span style="color:#75715e"></span>        Assert.Equal(HttpStatusCode.OK, register.StatusCode);
        Assert.Equal(HttpStatusCode.OK, login.StatusCode);
    }
}
</code></pre></div><p>Where <code>Login</code> and <code>Register</code> are some helper methods I was talking about earlier:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">async</span> Task&lt;HttpResponseMessage&gt; Register(HttpClient client, RegisterDto registerDto)
{
    <span style="color:#75715e">// Act
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> response = <span style="color:#66d9ef">await</span> client.PostAsJsonAsync(<span style="color:#e6db74">&#34;/user/register&#34;</span>, registerDto);
    <span style="color:#66d9ef">return</span> response;
}

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">async</span> Task&lt;HttpResponseMessage&gt; Login(HttpClient client, LoginDto loginDto)
{
    <span style="color:#75715e">// Act
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> response = <span style="color:#66d9ef">await</span> client.PostAsJsonAsync(<span style="color:#e6db74">&#34;/user/login&#34;</span>, loginDto);
    <span style="color:#66d9ef">return</span> response;
}
</code></pre></div><h2 id="requesting-an-endpoint-when-authenticated">Requesting An Endpoint When Authenticated<a hidden class="anchor" aria-hidden="true" href="#requesting-an-endpoint-when-authenticated">#</a></h2>
<p>In this example, we authenticate the request by registering and logging in using a helper method. This stores a JWT cookie. We then make a request to an endpoint that would usually be protected and make sure that the response is <code>OK</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MoonControllerTests</span> : IntegrationTestsBase
{
<span style="color:#a6e22e">    [Fact]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task Get_OneMoon_AsUser()
    {
        <span style="color:#75715e">// Arrange
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> client = GenerateClient();
        <span style="color:#66d9ef">await</span> AuthenticateAsUser(client);

        <span style="color:#75715e">// Act
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> response = <span style="color:#66d9ef">await</span> client.GetAsync(<span style="color:#e6db74">&#34;/moons/one&#34;</span>);

        <span style="color:#75715e">// Assert
</span><span style="color:#75715e"></span>        Assert.Equal(HttpStatusCode.OK, response.StatusCode);
    }
}
</code></pre></div><h1 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h1>
<p>Based on the following websites:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-6.0</a></li>
<li><a href="https://stackoverflow.com/questions/70900451/c-sharp-netcore-webapi-integration-testing-httpclient-uses-https-for-get-reques">https://stackoverflow.com/questions/70900451/c-sharp-netcore-webapi-integration-testing-httpclient-uses-https-for-get-reques</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://dombarter.co.uk/">Dom Barter</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
