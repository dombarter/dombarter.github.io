<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(Part 3) Add JWT based authentication and authorization to a .NET 6 Web API | Dom Barter</title>
<meta name="keywords" content="">
<meta name="description" content="Authenticate and authorize users calling your .NET 6 Web API by using JSON Web Tokens (JWTs)">
<meta name="author" content="Dom Barter">
<link rel="canonical" href="https://dombarter.co.uk/posts/add-dotnet-jwts-to-web-api/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://dombarter.co.uk/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dombarter.co.uk/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dombarter.co.uk/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dombarter.co.uk/apple-touch-icon.png">
<link rel="mask-icon" href="https://dombarter.co.uk/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="(Part 3) Add JWT based authentication and authorization to a .NET 6 Web API" />
<meta property="og:description" content="Authenticate and authorize users calling your .NET 6 Web API by using JSON Web Tokens (JWTs)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dombarter.co.uk/posts/add-dotnet-jwts-to-web-api/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-17T09:28:40&#43;01:00" />
<meta property="article:modified_time" content="2022-08-17T09:28:40&#43;01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="(Part 3) Add JWT based authentication and authorization to a .NET 6 Web API"/>
<meta name="twitter:description" content="Authenticate and authorize users calling your .NET 6 Web API by using JSON Web Tokens (JWTs)"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://dombarter.co.uk/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(Part 3) Add JWT based authentication and authorization to a .NET 6 Web API",
      "item": "https://dombarter.co.uk/posts/add-dotnet-jwts-to-web-api/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(Part 3) Add JWT based authentication and authorization to a .NET 6 Web API",
  "name": "(Part 3) Add JWT based authentication and authorization to a .NET 6 Web API",
  "description": "Authenticate and authorize users calling your .NET 6 Web API by using JSON Web Tokens (JWTs)",
  "keywords": [
    
  ],
  "articleBody": "GitHub Repository All the code in this series can be found at https://github.com/dombarter/Solar.API\nMotivation In my previous post, I explored how to manage login, registration and role assignment of our users using .NET Identity. In this post I am going to add JWT based authentication and authorization to our .NET 6 Web API.\nWhat are JWTs?  JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed.\n (https://jwt.io/introduction)\nJWTs are becoming increasingly popular in the world of single sign on, and are a very scalable, stateless and memory efficient way of providing authentication.\nNuGet Packages We need to install the following package:\n Microsoft.AspNetCore.Authentication.JwtBearer  Define The JWT Configuration JWTs are defined by some key parts including:\n Issuer (who has issued the key) Audience (who the key is intended for) Signing Key (a private random string used to sign the key)  We need to define these in our appsettings.json:\n{ \"Jwt\": { \"Key\": \"ThisIsMySecretKey\", \"Issuer\": \"localhost\", \"Audience\": \"localhost\" } } Don’t worry too much about the value of the Issuer and Audience, just make sure they’re the same. When used in a single sign on setting - we might have one machine generate the key, which could then be consumed by multiple different places. In our case we’re creating and consuming it in the same place. It’s just a straight string comparison.\nFor more information see https://www.rfc-editor.org/rfc/rfc7519#section-4.1.\nAmend The Startup Now we need to alter our startup class, Program.cs to configure our authentication mechanism. Specifically we are telling the Web API that it should look out for a JWT in the request headers, and use this to authenticate the current user.\n// Add JWTs builder.Services.AddAuthentication(auth = { auth.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; auth.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; }).AddJwtBearer(options = { options.SaveToken = true; options.TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = true, ValidateAudience = true, ValidateLifetime = true, ValidateIssuerSigningKey = true, ValidIssuer = builder.Configuration[\"Jwt:Issuer\"], ValidAudience = builder.Configuration[\"Jwt:Audience\"], IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration[\"Jwt:Key\"])) }; }); ... // Must be in this order app.UseAuthentication(); app.UseAuthorization(); Token Service We now need to make a token service, that will accept an IdentityUser and an expiry time, before generating a JWT we can return to the user.\n// TokenService.cs  using Microsoft.AspNetCore.Identity; using Microsoft.Extensions.Configuration; using Microsoft.IdentityModel.Tokens; using System.IdentityModel.Tokens.Jwt; using System.Security.Claims; using System.Text; namespace Solar.Services.Token { public class TokenService : ITokenService { private readonly UserManager _userManager; private readonly IConfiguration _config; public TokenService(UserManager userManager, IConfiguration config) { _userManager = userManager; _config = config; } async public Taskstring GenerateJwtToken(IdentityUser user, TimeSpan expiration) { // Define the token claims (username and unique guid)  var claims = new List { new Claim(JwtRegisteredClaimNames.Sub, user.UserName), new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()), }; // Add the roles to the token  foreach(var role in await _userManager.GetRolesAsync(user)) { claims.Add(new Claim(\"role\", role)); } // Encode our private JWT key  var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_config[\"Jwt:Key\"])); var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256); // Put everything together  var token = new JwtSecurityToken( issuer: _config[\"Jwt:Issuer\"], audience: _config[\"Jwt:Audience\"], expires: DateTime.UtcNow.Add(expiration), claims: claims, signingCredentials: creds ); // Build the token as a string  return new JwtSecurityTokenHandler().WriteToken(token); } } } Consuming The Token Service Now we have the token service setup we need to register it in the dependency injection container within Program.cs:\n// Add token service builder.Services.AddTransient(); We can then utilise the token service in our login action like so:\n[HttpPost] [Route(\"login\")] [AllowAnonymous] public async Taskstring Login([FromBody] LoginDto model) { var result = await _signInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, false); if (!result.Succeeded) { return BadRequest(\"Incorrect email or password\"); } // Generate JWT  var user = await _userManager.FindByNameAsync(model.Email); var token = await _tokenService.GenerateJwtToken(user, TimeSpan.FromMinutes(30)); return Ok(token); } Role Based Authorization Because we have configured our JWTs to include the role information, this means we can safely use the Authorize attributes across our controllers and actions:\n[HttpGet] [Route(\"one\")] [Authorize(Roles = \"User\")] public ActionResultstring GetRandomMoon() { return Moons[Random.Next(Moons.Count)]; } [HttpGet] [Route(\"two\")] [Authorize(Roles = \"Admin\")] public ActionResultstring GetTwoRandomMoons() { return $\"{Moons[Random.Next(Moons.Count)]}, {Moons[Random.Next(Moons.Count)]}\"; } Accessing The Current User Information Because we configured our JWTs to include the current username, this means we can grab the information of the user who the token belongs to - which could be helpful when making SQL etc.\n[HttpGet] [Route(\"user\")] [Authorize(Roles = \"Admin, User\")] public async Task GetLoggedInUser() { var username = User.FindFirst(ClaimTypes.NameIdentifier)?.Value; var user = await _userManager.FindByNameAsync(username); return new OkObjectResult(user); } Supporting JWT support to Swagger And finally, if you’d like to support the Authorize window in Swagger (adds the ability to pass the Bearer token with each subsequent request), add the following to your startup class:\n// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle builder.Services.AddEndpointsApiExplorer(); builder.Services.AddSwaggerGen(options = { var jwtSecurityScheme = new OpenApiSecurityScheme { Name = \"Authorization\", Type = SecuritySchemeType.Http, Scheme = JwtBearerDefaults.AuthenticationScheme, BearerFormat = \"JWT\", In = ParameterLocation.Header, Reference = new OpenApiReference { Type = ReferenceType.SecurityScheme, Id = JwtBearerDefaults.AuthenticationScheme } }; options.AddSecurityDefinition(JwtBearerDefaults.AuthenticationScheme, jwtSecurityScheme); options.AddSecurityRequirement(new OpenApiSecurityRequirement(){{ jwtSecurityScheme, new string[] {} }}); }); Testing The JWTs Using Swagger Load up swagger, login using your username and password, and grab the JWT from the response:\nNow scroll to the top of the page, and click on the Authorize button and paste in your token:\nMake sure to press Authorize to save the token!\nAnd finally, scroll to one of the endpoints that requires authentication and test it out. If you have a valid token and the correct roles - you will see the content returned. If not you’ll get a contextual http response (401 etc):\nReferences  https://docs.microsoft.com/en-us/aspnet/core/security/authorization/roles?view=aspnetcore-6.0 https://codewithmukesh.com/blog/aspnet-core-api-with-jwt-authentication/ https://weblog.west-wind.com/posts/2021/Mar/09/Role-based-JWT-Tokens-in-ASPNET-Core https://www.c-sharpcorner.com/article/how-to-add-jwt-bearer-token-authorization-functionality-in-swagger/ https://www.freecodespot.com/blog/use-jwt-bearer-authorization-in-swagger/  ",
  "wordCount" : "914",
  "inLanguage": "en",
  "datePublished": "2022-08-17T09:28:40+01:00",
  "dateModified": "2022-08-17T09:28:40+01:00",
  "author":{
    "@type": "Person",
    "name": "Dom Barter"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dombarter.co.uk/posts/add-dotnet-jwts-to-web-api/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dom Barter",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dombarter.co.uk/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dombarter.co.uk/" accesskey="h" title="Dom Barter (Alt + H)">Dom Barter</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://dombarter.co.uk/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://dombarter.co.uk/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://dombarter.co.uk/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://dombarter.co.uk/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://dombarter.co.uk/">Home</a>&nbsp;»&nbsp;<a href="https://dombarter.co.uk/posts/">Posts</a></div>
    <h1 class="post-title">
      (Part 3) Add JWT based authentication and authorization to a .NET 6 Web API
    </h1>
    <div class="post-meta"><span title='2022-08-17 09:28:40 +0100 +0100'>August 17, 2022</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Dom Barter

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul><ul><ul>
                <li>
                    <a href="#github-repository" aria-label="GitHub Repository">GitHub Repository</a></li></ul>
                    </ul>
                    
                <li>
                    <a href="#motivation" aria-label="Motivation">Motivation</a></li>
                <li>
                    <a href="#what-are-jwts" aria-label="What are JWTs?">What are JWTs?</a></li>
                <li>
                    <a href="#nuget-packages" aria-label="NuGet Packages">NuGet Packages</a></li>
                <li>
                    <a href="#define-the-jwt-configuration" aria-label="Define The JWT Configuration">Define The JWT Configuration</a></li>
                <li>
                    <a href="#amend-the-startup" aria-label="Amend The Startup">Amend The Startup</a></li>
                <li>
                    <a href="#token-service" aria-label="Token Service">Token Service</a></li>
                <li>
                    <a href="#consuming-the-token-service" aria-label="Consuming The Token Service">Consuming The Token Service</a></li>
                <li>
                    <a href="#role-based-authorization" aria-label="Role Based Authorization">Role Based Authorization</a></li>
                <li>
                    <a href="#accessing-the-current-user-information" aria-label="Accessing The Current User Information">Accessing The Current User Information</a></li>
                <li>
                    <a href="#supporting-jwt-support-to-swagger" aria-label="Supporting JWT support to Swagger">Supporting JWT support to Swagger</a></li>
                <li>
                    <a href="#testing-the-jwts-using-swagger" aria-label="Testing The JWTs Using Swagger">Testing The JWTs Using Swagger</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="github-repository">GitHub Repository<a hidden class="anchor" aria-hidden="true" href="#github-repository">#</a></h3>
<p>All the code in this series can be found at <a href="https://github.com/dombarter/Solar.API">https://github.com/dombarter/Solar.API</a></p>
<h1 id="motivation">Motivation<a hidden class="anchor" aria-hidden="true" href="#motivation">#</a></h1>
<p>In my <a href="/posts/add-dotnet-jwts-to-web-api">previous post</a>, I explored how to manage login, registration and role assignment of our users using .NET Identity. In this post I am going to add JWT based authentication and authorization to our .NET 6 Web API.</p>
<h1 id="what-are-jwts">What are JWTs?<a hidden class="anchor" aria-hidden="true" href="#what-are-jwts">#</a></h1>
<blockquote>
<p>JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed.</p>
</blockquote>
<p>(<a href="https://jwt.io/introduction">https://jwt.io/introduction</a>)</p>
<p>JWTs are becoming increasingly popular in the world of single sign on, and are a very scalable, stateless and memory efficient way of providing authentication.</p>
<h1 id="nuget-packages">NuGet Packages<a hidden class="anchor" aria-hidden="true" href="#nuget-packages">#</a></h1>
<p>We need to install the following package:</p>
<ul>
<li>Microsoft.AspNetCore.Authentication.JwtBearer</li>
</ul>
<h1 id="define-the-jwt-configuration">Define The JWT Configuration<a hidden class="anchor" aria-hidden="true" href="#define-the-jwt-configuration">#</a></h1>
<p>JWTs are defined by some key parts including:</p>
<ul>
<li>Issuer (who has issued the key)</li>
<li>Audience (who the key is intended for)</li>
<li>Signing Key (a private random string used to sign the key)</li>
</ul>
<p>We need to define these in our <code>appsettings.json</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;Jwt&#34;</span>: {
    <span style="color:#f92672">&#34;Key&#34;</span>: <span style="color:#e6db74">&#34;ThisIsMySecretKey&#34;</span>,
    <span style="color:#f92672">&#34;Issuer&#34;</span>: <span style="color:#e6db74">&#34;localhost&#34;</span>,
    <span style="color:#f92672">&#34;Audience&#34;</span>: <span style="color:#e6db74">&#34;localhost&#34;</span>
  }
}
</code></pre></div><p>Don&rsquo;t worry too much about the value of the <code>Issuer</code> and <code>Audience</code>, just make sure they&rsquo;re the same. When used in a single sign on setting - we might have one machine generate the key, which could then be consumed by multiple different places. In our case we&rsquo;re creating and consuming it in the same place. It&rsquo;s just a straight string comparison.</p>
<p>For more information see <a href="https://www.rfc-editor.org/rfc/rfc7519#section-4.1">https://www.rfc-editor.org/rfc/rfc7519#section-4.1</a>.</p>
<h1 id="amend-the-startup">Amend The Startup<a hidden class="anchor" aria-hidden="true" href="#amend-the-startup">#</a></h1>
<p>Now we need to alter our startup class, <code>Program.cs</code> to configure our authentication mechanism. Specifically we are telling the Web API that it should look out for a JWT in the request headers, and use this to authenticate the current user.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// Add JWTs
</span><span style="color:#75715e"></span>builder.Services.AddAuthentication(auth =&gt;
{
    auth.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    auth.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
}).AddJwtBearer(options =&gt;
{
    options.SaveToken = <span style="color:#66d9ef">true</span>;
    options.TokenValidationParameters = <span style="color:#66d9ef">new</span> TokenValidationParameters
    {
        ValidateIssuer = <span style="color:#66d9ef">true</span>,
        ValidateAudience = <span style="color:#66d9ef">true</span>,
        ValidateLifetime = <span style="color:#66d9ef">true</span>,
        ValidateIssuerSigningKey = <span style="color:#66d9ef">true</span>,
        ValidIssuer = builder.Configuration[<span style="color:#e6db74">&#34;Jwt:Issuer&#34;</span>],
        ValidAudience = builder.Configuration[<span style="color:#e6db74">&#34;Jwt:Audience&#34;</span>],
        IssuerSigningKey = <span style="color:#66d9ef">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration[<span style="color:#e6db74">&#34;Jwt:Key&#34;</span>]))
    };
});

...

<span style="color:#75715e">// Must be in this order
</span><span style="color:#75715e"></span>app.UseAuthentication();
app.UseAuthorization();
</code></pre></div><h1 id="token-service">Token Service<a hidden class="anchor" aria-hidden="true" href="#token-service">#</a></h1>
<p>We now need to make a token service, that will accept an <code>IdentityUser</code> and an expiry time, before generating a JWT we can return to the user.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// TokenService.cs
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">using</span> Microsoft.AspNetCore.Identity;
<span style="color:#66d9ef">using</span> Microsoft.Extensions.Configuration;
<span style="color:#66d9ef">using</span> Microsoft.IdentityModel.Tokens;
<span style="color:#66d9ef">using</span> System.IdentityModel.Tokens.Jwt;
<span style="color:#66d9ef">using</span> System.Security.Claims;
<span style="color:#66d9ef">using</span> System.Text;

<span style="color:#66d9ef">namespace</span> Solar.Services.Token
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TokenService</span> : ITokenService
    {
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> UserManager&lt;IdentityUser&gt; <span style="color:#ae81ff">_</span>userManager;
        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IConfiguration <span style="color:#ae81ff">_</span>config;

        <span style="color:#66d9ef">public</span> TokenService(UserManager&lt;IdentityUser&gt; userManager, IConfiguration config)
        {
            <span style="color:#ae81ff">_</span>userManager = userManager;
            <span style="color:#ae81ff">_</span>config = config;
        }

        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">public</span> Task&lt;<span style="color:#66d9ef">string</span>&gt; GenerateJwtToken(IdentityUser user, TimeSpan expiration)
        {
            <span style="color:#75715e">// Define the token claims (username and unique guid)
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">var</span> claims = <span style="color:#66d9ef">new</span> List&lt;Claim&gt;
            {
                <span style="color:#66d9ef">new</span> Claim(JwtRegisteredClaimNames.Sub, user.UserName),
                <span style="color:#66d9ef">new</span> Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
            };

            <span style="color:#75715e">// Add the roles to the token
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">foreach</span>(<span style="color:#66d9ef">var</span> role <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">await</span> <span style="color:#ae81ff">_</span>userManager.GetRolesAsync(user))
            {
                claims.Add(<span style="color:#66d9ef">new</span> Claim(<span style="color:#e6db74">&#34;role&#34;</span>, role));
            }

            <span style="color:#75715e">// Encode our private JWT key
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">var</span> key = <span style="color:#66d9ef">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(<span style="color:#ae81ff">_</span>config[<span style="color:#e6db74">&#34;Jwt:Key&#34;</span>]));
            <span style="color:#66d9ef">var</span> creds = <span style="color:#66d9ef">new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            <span style="color:#75715e">// Put everything together
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">var</span> token = <span style="color:#66d9ef">new</span> JwtSecurityToken(
                issuer: <span style="color:#ae81ff">_</span>config[<span style="color:#e6db74">&#34;Jwt:Issuer&#34;</span>],
                audience: <span style="color:#ae81ff">_</span>config[<span style="color:#e6db74">&#34;Jwt:Audience&#34;</span>],
                expires: DateTime.UtcNow.Add(expiration),
                claims: claims,
                signingCredentials: creds
            );

            <span style="color:#75715e">// Build the token as a string
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}
</code></pre></div><h1 id="consuming-the-token-service">Consuming The Token Service<a hidden class="anchor" aria-hidden="true" href="#consuming-the-token-service">#</a></h1>
<p>Now we have the token service setup we need to register it in the dependency injection container within <code>Program.cs</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// Add token service
</span><span style="color:#75715e"></span>builder.Services.AddTransient&lt;ITokenService, TokenService&gt;();
</code></pre></div><p>We can then utilise the token service in our login action like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[HttpPost]</span>
<span style="color:#a6e22e">[Route(&#34;login&#34;)]</span>
<span style="color:#a6e22e">[AllowAnonymous]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;ActionResult&lt;<span style="color:#66d9ef">string</span>&gt;&gt; Login([FromBody] LoginDto model)
{
    <span style="color:#66d9ef">var</span> result = <span style="color:#66d9ef">await</span> <span style="color:#ae81ff">_</span>signInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, <span style="color:#66d9ef">false</span>);

    <span style="color:#66d9ef">if</span> (!result.Succeeded)
    {
        <span style="color:#66d9ef">return</span> BadRequest(<span style="color:#e6db74">&#34;Incorrect email or password&#34;</span>);
    }

    <span style="color:#75715e">// Generate JWT
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> user = <span style="color:#66d9ef">await</span> <span style="color:#ae81ff">_</span>userManager.FindByNameAsync(model.Email);
    <span style="color:#66d9ef">var</span> token = <span style="color:#66d9ef">await</span> <span style="color:#ae81ff">_</span>tokenService.GenerateJwtToken(user, TimeSpan.FromMinutes(<span style="color:#ae81ff">30</span>));

    <span style="color:#66d9ef">return</span> Ok(token);
}
</code></pre></div><h1 id="role-based-authorization">Role Based Authorization<a hidden class="anchor" aria-hidden="true" href="#role-based-authorization">#</a></h1>
<p>Because we have configured our JWTs to include the role information, this means we can safely use the <code>Authorize</code> attributes across our controllers and actions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[HttpGet]</span>
<span style="color:#a6e22e">[Route(&#34;one&#34;)]</span>
<span style="color:#a6e22e">[Authorize(Roles = &#34;User&#34;)]</span>
<span style="color:#66d9ef">public</span> ActionResult&lt;<span style="color:#66d9ef">string</span>&gt; GetRandomMoon()
{
    <span style="color:#66d9ef">return</span> Moons[Random.Next(Moons.Count)];
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[HttpGet]</span>
<span style="color:#a6e22e">[Route(&#34;two&#34;)]</span>
<span style="color:#a6e22e">[Authorize(Roles = &#34;Admin&#34;)]</span>
<span style="color:#66d9ef">public</span> ActionResult&lt;<span style="color:#66d9ef">string</span>&gt; GetTwoRandomMoons()
{
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">$&#34;{Moons[Random.Next(Moons.Count)]}, {Moons[Random.Next(Moons.Count)]}&#34;</span>;
}
</code></pre></div><h1 id="accessing-the-current-user-information">Accessing The Current User Information<a hidden class="anchor" aria-hidden="true" href="#accessing-the-current-user-information">#</a></h1>
<p>Because we configured our JWTs to include the current username, this means we can grab the information of the user who the token belongs to - which could be helpful when making SQL etc.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[HttpGet]</span>
<span style="color:#a6e22e">[Route(&#34;user&#34;)]</span>
<span style="color:#a6e22e">[Authorize(Roles = &#34;Admin, User&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;ActionResult&lt;IdentityUser&gt;&gt; GetLoggedInUser()
{
    <span style="color:#66d9ef">var</span> username = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    <span style="color:#66d9ef">var</span> user = <span style="color:#66d9ef">await</span> <span style="color:#ae81ff">_</span>userManager.FindByNameAsync(username);
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> OkObjectResult(user);
}
</code></pre></div><h1 id="supporting-jwt-support-to-swagger">Supporting JWT support to Swagger<a hidden class="anchor" aria-hidden="true" href="#supporting-jwt-support-to-swagger">#</a></h1>
<p>And finally, if you&rsquo;d like to support the Authorize window in Swagger (adds the ability to pass the Bearer token with each subsequent request), add the following to your startup class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
</span><span style="color:#75715e"></span>builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(options =&gt;
{
    <span style="color:#66d9ef">var</span> jwtSecurityScheme = <span style="color:#66d9ef">new</span> OpenApiSecurityScheme
    {
        Name = <span style="color:#e6db74">&#34;Authorization&#34;</span>,
        Type = SecuritySchemeType.Http,
        Scheme = JwtBearerDefaults.AuthenticationScheme,
        BearerFormat = <span style="color:#e6db74">&#34;JWT&#34;</span>,
        In = ParameterLocation.Header,
        Reference = <span style="color:#66d9ef">new</span> OpenApiReference
        {
            Type = ReferenceType.SecurityScheme,
            Id = JwtBearerDefaults.AuthenticationScheme
        }
    };

    options.AddSecurityDefinition(JwtBearerDefaults.AuthenticationScheme, jwtSecurityScheme);
    options.AddSecurityRequirement(<span style="color:#66d9ef">new</span> OpenApiSecurityRequirement(){{ jwtSecurityScheme, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>[] {} }});
});
</code></pre></div><h1 id="testing-the-jwts-using-swagger">Testing The JWTs Using Swagger<a hidden class="anchor" aria-hidden="true" href="#testing-the-jwts-using-swagger">#</a></h1>
<p>Load up swagger, login using your username and password, and grab the JWT from the response:</p>
<p><img loading="lazy" src="/images/jwt-header-swagger/login.png" alt="login"  />
</p>
<p>Now scroll to the top of the page, and click on the <code>Authorize</code> button and paste in your token:</p>
<p><img loading="lazy" src="/images/jwt-header-swagger/authorize.png" alt="authorize"  />
</p>
<p>Make sure to press <code>Authorize</code> to save the token!</p>
<p>And finally, scroll to one of the endpoints that requires authentication and test it out. If you have a valid token and the correct roles - you will see the content returned. If not you&rsquo;ll get a contextual http response (401 etc):</p>
<p><img loading="lazy" src="/images/jwt-header-swagger/moons.png" alt="moons"  />
</p>
<h1 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h1>
<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/roles?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/security/authorization/roles?view=aspnetcore-6.0</a></li>
<li><a href="https://codewithmukesh.com/blog/aspnet-core-api-with-jwt-authentication/">https://codewithmukesh.com/blog/aspnet-core-api-with-jwt-authentication/</a></li>
<li><a href="https://weblog.west-wind.com/posts/2021/Mar/09/Role-based-JWT-Tokens-in-ASPNET-Core">https://weblog.west-wind.com/posts/2021/Mar/09/Role-based-JWT-Tokens-in-ASPNET-Core</a></li>
<li><a href="https://www.c-sharpcorner.com/article/how-to-add-jwt-bearer-token-authorization-functionality-in-swagger/">https://www.c-sharpcorner.com/article/how-to-add-jwt-bearer-token-authorization-functionality-in-swagger/</a></li>
<li><a href="https://www.freecodespot.com/blog/use-jwt-bearer-authorization-in-swagger/">https://www.freecodespot.com/blog/use-jwt-bearer-authorization-in-swagger/</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://dombarter.co.uk/">Dom Barter</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
